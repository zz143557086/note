### TCP

#### 什么是双工

发送和接收的是可以同时执行的

#### TCP为何需要三次握手

三次握手的最主要目的是保证连接时双工的，可靠更多的是通过重传机制来保证的

#### TCP为何需要四次挥手

因为连接时全双工的，双方必须都收到对方的FIN包及确认才可关闭

#### TCP的三次握手

1.客服端向服务端发送一个SYN包请求连接

2.服务端向客服端发送一个SYN包加一个ACK包表示客服端可以连接

3.客服端收到ack包去建立这个连接

#### TCP的四次挥手

1.主动关闭方发送一个FIN包

2.被动接收包表示已经收到这个请求发送一个ACK包

3.被动接收包完成关闭操作回复一个FIN包表示可以关闭了

4.主动接收到FIN包发送一个ACK包表示确认关闭

### 为什么time_wait需要等待2MSL

1.MSL:Maximum Segment Lifetime，30--1分钟

2.保证TCP协议的全双工连接能够可靠关闭

3.保证这次连接的重复段从网络中消失

### 为什么会出现大量Close wait

1.close_wait一般出现在被动关闭方

2.并发请求太多导致的

3.被动关闭方未及时释放端口资源导致

### TCP为啥需要流量控制

1.由于通讯双方，网速不同。通讯方任一方发送过快都会导致对方信息处理不过来，所有就需要把数据放到缓存区中

2.如果缓冲区满了，发送方还在疯狂发送，那接收方只能把数据包丢弃。因此我们需要控制发送速率。

3.我们缓存区剩余大小称为接收窗口，用变量win表示。如果win=0，则发送方停止发送

### TCP为啥需要拥塞控制

1.流量控制与拥塞控制是两个概念，拥塞控制是调节网络的负载

2.接收方网络资源繁忙，因未及时相应ACK导致发送方重传大量数据，这样将会导致网络更加拥堵

3.拥塞控制是动态调整win大小，不只是依赖缓存区大小确定窗口大小

TCP的拥塞控制

#### 1.慢开始和拥塞避免

发送方第一次发送一个，接收方回复后。发送方发送两个，接收方回复两个。

依次指向性乘2增加，到达阈拥塞避免值线性增长。如果网络拥塞，拥塞窗口会直接变为1，阈值变为拥塞值一半。再进入慢启动阶段

#### 2.快速重传和快速恢复

再到达网络拥塞值时，阈值为拥塞值的一半，拥塞窗口直接降到阈值不降为1，然后快恢复

### 为什么需要粘包-拆包

#### 粘包

1.不同请求合并到一个报文中

2.应用程序写入数据小于socket缓冲区大小，网卡将应用多次写入的数据发生到网络上

#### 拆包

1.一次请求拆多个TCP报文中

2.应用程序写入的数据大于socket缓冲区大小，这将发生拆包

3.进行MSS(最大报文长度1460or1480)大小的TCP分段，当TCP报文长度-TCP头部长度>MSS的时候将发生拆包

### 如何获取完整应用数据报文

1.使用带消息头的协议，头部写入包长度，然后再读取包内容。

2.设置定长消息，每次读取定长内容，长度不够时空位补固字符

3.设置消息边界，服务端从网络流中按息边界分离出消息内容，一般使用'\n'。

4.更为复杂的协程，例如json，protobuf